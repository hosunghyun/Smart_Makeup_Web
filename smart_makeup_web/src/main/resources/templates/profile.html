<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>프로필 페이지</title>
    <link rel="stylesheet" th:href="@{/main.css}">

    <!-- 부트스트랩 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <!-- 메뉴바 -->
    <div th:replace="~{menubar.html::global-menubar}"></div>

    <label for="">아이디</label><input type="text" th:value="${member.getMember_id()}" readonly>
    <form action="">
        <label for="pwd">새 비밀번호</label><input type="password" name="pwd" id="pwd"><br>
        <label for="newpwd">새 비밀번호 확인</label><input type="password" name="newpwd" id="newpwd"><p id="checkpwd"></p><br>
        <label for="email">이메일</label><input type="email" name="email" id="email" th:value="${member.getEmail()}"><br>
        <label for="phone">연락처</label><input type="tel" name="phone" id="phone" th:value="${member.getPhone()}"><br>
        <button type="button" id="chbtn">수정하기</button>
        <button type="button" id="delbtn">회원탈퇴</button>
    </form>

    <!-- 회원 탈퇴하는 기능 -->
    <script>
        (()=>{
            document.getElementById("delbtn").addEventListener('click', ()=>{
                const yn = confirm("정말로 탈퇴하시겠습니까?");
                if(yn) {
                    const pwd = prompt("비밀번호를 입력해주세요.", "");
                    fetch(`/withdraw`, {
                        method : 'POST',
                        headers : { "Content-Type" : "application/json" },
                        body : JSON.stringify({"member_password" : pwd})
                    })
                    .then((message)=>{ return message.text() })
                    .then((message)=>{
                    if(message == "fails") {    // 컨트롤러에서 비밀번호가 맞는 확인한 결과
                        alert(`잘못된 비밀번호입니다.`);
                    }
                    else {
                        alert("회원 탈퇴에 성공했습니다.")
                        window.location.href = `/index`;
                    }
                });
                }
            });
        })();
    </script>

    <!-- 새 비밀번호와 새 비밀번호 확인이 서로 맞는지 확인 -->
    <script>
        (()=>{
            const $pwd = document.getElementById("pwd");
            const $checkpwd = document.getElementById("checkpwd");
            const $newpwd = document.getElementById("newpwd");
            
            $newpwd.addEventListener('input', () => {
                // 새 비밀번호 입력이 비어있는 경우
                if ($newpwd.value === "") {
                    $checkpwd.textContent = "";
                    return;
                }

                // 비밀번호가 같은 경우
                if ($pwd.value === $newpwd.value) {
                    $checkpwd.textContent = "비밀번호가 같습니다.";
                    $checkpwd.style.color = "green"; // 초록색으로 표시
                } else {
                    // 비밀번호가 다른 경우
                    $checkpwd.textContent = "비밀번호가 다릅니다.";
                    $checkpwd.style.color = "red"; // 빨간색으로 표시
                }
            });
        })();
    </script>

    <!-- 회원 수정하기 버튼 구현 -->
    <script th:inline="javascript">
        (() => {
            /*<![CDATA[*/
            const $member_id = /*[[${member.getMember_id()}]]*/ ''; // 회원 아이디 가져오기
            const $pwd = document.getElementById("pwd");          // 변경할 비밀번호
            const $newpwd = document.getElementById("newpwd");    // 새 비밀번호 확인
            const $email = document.getElementById("email");      // 이메일
            const $phone = document.getElementById("phone");      // 연락처
            const $chbtn = document.getElementById("chbtn");      // 회원 수정 버튼
        
            $chbtn.addEventListener('click', () => {
                // 비밀번호 확인
                if ($pwd.value === $newpwd.value) {
                    const $member = {
                        member_id: $member_id,
                        member_password: $pwd.value, // 비밀번호 값을 가져옴
                        email: $email.value,         // 이메일 값을 가져옴
                        phone: $phone.value          // 전화번호 값을 가져옴
                    };
                    fetch(`/change/member-info`, {
                        method: 'POST',
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify($member)
                    })
                    .then(response => response.text())
                    .then(message => {
                        if (message === "fails") { // 회원 정보 수정 실패
                            alert("회원정보 수정에 실패했습니다.");
                        } else {
                            alert("회원정보 수정에 성공했습니다.");
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert("오류가 발생했습니다. 나중에 다시 시도해주세요.");
                    });
                } else {
                    alert("비밀번호가 일치하지 않습니다.");
                }
            });
            /*]]>*/
        })();
    </script>        
</body>
</html>